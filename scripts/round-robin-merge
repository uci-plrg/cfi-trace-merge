#!/bin/bash

. $csc/scripts/cs-common

function print_usage() {
  echo "Usage: "
  echo "    round-robin-merge <logdir> <run-dir>*"
  echo "    round-robin-merge <logdir> <run-listing> (file of <run-dir>*)"
  echo "    -r : resume (skip completed executions)"
  echo "    -v : verbose output"
}

check_help $1 print_usage

while getopts "rv" Option
do
  case $Option in
    r ) skip=true;;
    v ) verbose=true;;
    * ) usage; exit;;
  esac
done
shift $(($OPTIND - 1))

logdir=${1%/}
shift

if [ -f "$1" ]
then
  targets=$(cat $1)
else
  for d in $@
  do
    targets=$targets" "$d
  done
fi

runs=($(find -L $targets -type 'f' -name "*.bb-graph.*" | sed "s/\/[^/]\+$//" | sort))

echo "Found "${#runs[@]}" runs"
for ((i = 0; (i + 1) < ${#runs[@]}; i++))
do
  if [ ${runs[$i]} == ${runs[$i+1]} ] 
  then
    echo "Multiple runs found in directory "${runs[$i]}
    echo "Merging requires each run to be in its own directory"
    exit
  fi
done

for ((i = 0; (i + 1) < ${#runs[@]}; i++))
do
  for ((j = ($i + 1); j < ${#runs[@]}; j++))
  do
    a=${runs[$i]}
    b=${runs[$j]}
    logfile=$logdir"/"`echo $a | egrep -o "[^\/]+$"`"~"`echo $b | egrep -o "[^\/]+$"`".merge.log"
    [ ! -z $skip ] && [ -e $logfile ] && { [ ! -z $verbose ] && echo "Skipping completed merge "$logfile; continue; }
    cs-merge $a $b $logfile
  done
done
